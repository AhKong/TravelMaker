<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cafe24.travelMaker.mapper.ReviewMapper">
	<resultMap type="ResReview" id="resReviewResultMap" >
		<result property ="resReviewNum" column ="res_review_num"/>
		<result property ="resNum" column ="res_Num"/>
		<result property ="resReviewTitle" column ="res_review_title"/>
		<result property ="resReviewContents" column ="res_review_contents"/>
		<result property ="resReviewGrade" column ="res_review_grade"/>
		<result property ="resReviewPhoto" column ="res_review_photo"/>
		<result property ="resReveiwRegDate" column ="res_review_reg_date"/>
		<result property ="resReveiwUpdateDate" column ="res_review_update_date"/>
		<result property ="resVisitDate" column ="res_review_visit_date"/>
		<association property="tripType" javaType ="TripType">
 			<result property="tripTypeNum" column="trip_type_num"/>
 			<result property="tripTypeName"  column="trip_type_name"/>
 		</association>
 		<association property="member" javaType ="Member">
 			<result property="mId" column="m_id"/>
 			<result property="mAvatar"  column="m_avatar"/>
 		</association>
	</resultMap>
	
     <select id="selectTripTypeList" resultType="TripType">
     	SELECT 
     		trip_type_num as tripTypeNum,
     		trip_type_name as tripTypeName
     	FROM
     		tb_trip_type
     </select>  
     
     <insert id="addResReview" parameterType="ResReview">
     	  <selectKey order ="BEFORE" keyProperty="resReviewNum" resultType ="String"> 
		 	 SELECT 
				case COUNT(*)
				when 0 then 'res_review_1'
				ELSE CONCAT('res_review_',MAX(CAST(SUBSTRING(res_review_num,12) AS DECIMAL))+1) 
				END AS res_review_num
			FROM
				tb_res_review
 	 	 </selectKey>
 	 	 
 	 	 INSERT INTO
			 tb_res_review(
			 	res_review_num,
			 	m_id, 
				res_num,
				res_review_title, 
				res_review_contents, 
				res_review_grade, 
				res_review_photo,
				res_travel_type,
				res_review_visit_date
		)VALUES (
				#{resReviewNum},
				#{mId},
				#{resNum},
				#{resReviewTitle},
				#{resReviewContents},
				#{resReviewGrade},
				#{resReviewPhoto},
				#{resTravelType},
				#{resVisitDate}
		)
     </insert>  

	<select id="isWritedReview" parameterType="String" resultType="int">  
		SELECT
			count(*)
		FROM
			tb_res_review
		WHERE
			m_id =#{mId} and res_num =#{resNum} and res_review_status='Y';
	</select>         
	
	<select id="resReviewList" parameterType="String" resultMap="resReviewResultMap">
		SELECT 
			m.m_avatar,
			r.*,
			t.trip_type_name
		FROM 
			tb_res_review  AS r
		INNER JOIN 
			tb_member AS m 
		INNER JOIN
			tb_trip_type AS t
		ON  
		 	m.m_id = r.m_id AND r.res_travel_type = t.trip_type_num 
		WHERE  r.res_num =#{resNum}
	</select>     
	<select id="getGradeCnt"  parameterType="String" resultType="ReviewGrade">
		SELECT 
			r.res_review_grade as grade,
			count(*) as gradeCnt
		FROM 
			tb_res_review AS r
		WHERE 
			r.res_num =#{resNum}
		GROUP BY  
			r.res_review_grade
	</select>    
	<select id="isLiked" parameterType="String" resultType="int">
		select 
			count(*)
		from
			tb_res_review_like
		where
			m_id = #{mId} and res_review_num = #{reviewNum}	
	</select>                                                                                                            
</mapper>