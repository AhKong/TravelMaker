<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cafe24.travelMaker.mapper.MsgMapper">
	<resultMap  type="Message" id="msgResultMap" >
 		<result property="messageNum"  	column="message_num"/>
 		<result property="mId"   	column="m_id"/>
 		<result property="targetId"  column="target_id"/>
 		<result property="contents" 	column="message_contents"/>
 		<result property="isChecked"  column="message_check"/>
 		<result property="msgSendTime"  column="message_send"/>
 		<result property="msgReadTime"  column="message_read"/>		
	</resultMap>

	<insert id="sendMsg" parameterType="Message">
		<selectKey order ="BEFORE" keyProperty="messageNum" resultType ="String"> 
		 	 SELECT 
				case COUNT(*)
				when 0 then 'message_1'
				ELSE CONCAT('message_',MAX(CAST(SUBSTRING(message_num,9) AS DECIMAL))+1) 
				END AS message_num
			FROM
				tb_message
			</selectKey>
			INSERT INTO 
				tb_message(
					message_num,
					m_id, 
					target_id, 
					message_contents)
			VALUES (#{messageNum}, #{mId}, #{targetId}, #{contents})
	</insert>

	<select id="receivedMsgList" parameterType="String" resultMap="msgResultMap">
		select
			*
		from 
			tb_message
		where 
			target_id =#{mId};
	</select>
	
	
</mapper>